#!/bin/bash

LOG=~/frozen_procs.log
declare -A last_seen
declare -A frozen

INTERVAL=5
TIMEOUT=120  # 2 Ñ…Ð²Ð¸Ð»Ð¸Ð½Ð¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ–

WHITELIST="(vesktop|wezterm|spotify)"

echo "â³ Ð’Ñ–Ð´ÑÑ‚ÐµÐ¶ÐµÐ½Ð½Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ð²Ñ–ÐºÐ½Ð°..."

while true; do
  active_info=$(hyprctl activewindow -j 2>/dev/null)
  active_pid=$(echo "$active_info" | jq '.pid')
  active_address=$(echo "$active_info" | jq -r '.address')

  if [[ -z "$active_pid" || "$active_pid" == "null" ]]; then
    echo "[!] ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ðµ Ð²Ñ–ÐºÐ½Ð¾. ÐŸÑ€Ð¾Ð¿ÑƒÑÐº..."
    sleep $INTERVAL
    continue
  fi

  echo "[âœ”] ÐÐºÑ‚Ð¸Ð²Ð½Ðµ Ð²Ñ–ÐºÐ½Ð¾: PID $active_pid"

  now=$(date +%s)

  # ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ñ‡Ð°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ–
  last_seen[$active_pid]=$now

  # Ð Ð¾Ð·Ð¼Ð¾Ñ€Ð¾Ð·Ð¸Ñ‚Ð¸, ÑÐºÑ‰Ð¾ ÑÑ‚Ð°Ð»Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸Ð¼
  if [[ "${frozen[$active_pid]}" == "1" ]]; then
    kill -CONT "$active_pid" 2>/dev/null
    if [[ $? -eq 0 ]]; then
      echo "ðŸŸ¢ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ñ€Ð¾Ð·Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð¾ PID $active_pid (ÑÑ‚Ð°Ð»Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸Ð¼)"
      unset frozen[$active_pid]
      sed -i "/^$active_pid\$/d" "$LOG" 2>/dev/null
    fi
  fi

  # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ð²ÑÑ– Ð²Ð¸Ð´Ð¸Ð¼Ñ– Ð²Ñ–ÐºÐ½Ð°, Ð°Ð»Ðµ Ð½Ðµ Ñ‡Ñ–Ð¿Ð°Ñ‚Ð¸ Ñ„Ð¾Ð½Ð¾Ð²Ñ–
  for client in $(hyprctl clients -j | jq -c '.[]'); do
    win_address=$(echo "$client" | jq -r '.address')
    pid=$(echo "$client" | jq '.pid')
    cmd=$(ps -p $pid -o comm= 2>/dev/null)

    [[ -z "$pid" || "$pid" == "$active_pid" ]] && continue
    [[ "$cmd" =~ $WHITELIST ]] && continue

    seen=${last_seen[$pid]}
    [[ -z "$seen" ]] && last_seen[$pid]=$now && continue

    elapsed=$((now - seen))

    if (( elapsed >= TIMEOUT )) && [[ "${frozen[$pid]}" != "1" ]]; then
      kill -STOP "$pid" 2>/dev/null
      if [[ $? -eq 0 ]]; then
        frozen[$pid]=1
        echo "ðŸ¥¶ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð·Ð°Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð¾ PID $pid ($elapsed ÑÐµÐº Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ–)"
        echo "$pid" >> "$LOG"
      fi
    fi
  done

  sleep $INTERVAL
done

